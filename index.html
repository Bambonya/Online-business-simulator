<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MMO –ë–∏–∑–Ω–µ—Å –°–∏–º—É–ª—è—Ç–æ—Ä</title>
<style>
body{margin:0;font-family:Arial;background:#0f172a;color:white}
.screen{display:none;padding:16px}
.screen.active{display:block}
button{width:100%;padding:14px;margin-top:8px;border:none;border-radius:10px;background:#22c55e;font-size:16px}
.card{background:#1e293b;padding:12px;border-radius:10px;margin-top:10px}
.small{font-size:14px;opacity:.8}
.flex{display:flex;gap:8px}
.flex button{flex:1}
input{width:100%;padding:10px;border-radius:6px;border:none;margin-top:6px}
.progress{height:10px;background:#334155;border-radius:6px;overflow:hidden;margin-top:6px}
.progress div{height:100%;width:0%;background:#22c55e}
</style>
</head>
<body>

<!-- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø -->
<div id="auth" class="screen active">
<h2>üë§ –í—Ö–æ–¥</h2>
<input id="login" placeholder="–õ–æ–≥–∏–Ω">
<button onclick="login()">–ò–≥—Ä–∞—Ç—å</button>
</div>

<!-- –ò–ì–†–ê -->
<div id="game" class="screen">
<h2 id="playerName"></h2>
<div class="card">üí∞ –î–µ–Ω—å–≥–∏: <span id="money">0</span></div>
<div class="card">üìÖ –°–µ–∑–æ–Ω: <span id="season">1</span></div>

<!-- –ë–ò–ó–ù–ï–°–´ -->
<div class="card">
<h3>üè¢ –ë–∏–∑–Ω–µ—Å—ã</h3>
<div id="businessList"></div>
</div>

<!-- –ê–ö–¶–ò–ò -->
<div class="card">
<h3>üìä –ê–∫—Ü–∏–∏</h3>
<div>–¶–µ–Ω–∞: <span id="stockPrice">100</span>‚ÇΩ</div>
<div>–ê–∫—Ü–∏–π: <span id="stocks">0</span></div>
<div class="flex">
<button onclick="buyStock()">–ö—É–ø–∏—Ç—å</button>
<button onclick="sellStock()">–ü—Ä–æ–¥–∞—Ç—å</button>
</div>
</div>

<!-- –ö–û–ù–¢–†–ê–ö–¢–´ -->
<div class="card">
<h3>üìÑ –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã</h3>
<div id="contractStatus" class="small">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</div>
<button onclick="startContract()">–í–∑—è—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç (20 —Å–µ–∫)</button>
</div>

<!-- –ö–†–ï–î–ò–¢–´ -->
<div class="card">
<h3>üè¶ –ö—Ä–µ–¥–∏—Ç—ã</h3>
<div id="loanInfo" class="small">–ö—Ä–µ–¥–∏—Ç–æ–≤ –Ω–µ—Ç</div>
<button onclick="takeLoan()">–í–∑—è—Ç—å –∫—Ä–µ–¥–∏—Ç 1000‚ÇΩ</button>
<button onclick="repayLoan()">–ü–æ–≥–∞—Å–∏—Ç—å –∫—Ä–µ–¥–∏—Ç</button>
</div>

<!-- –î–û–ù–ê–¢ -->
<div class="card">
<h3>üí∞ –î–æ–Ω–∞—Ç</h3>
<div class="flex">
  <button onclick="buyMoney()">–ö—É–ø–∏—Ç—å 1000‚ÇΩ</button>
  <button onclick="buySpeed()">–£—Å–∫–æ—Ä–∏—Ç—å –±–∏–∑–Ω–µ—Å +1</button>
  <button onclick="buyProfit()">–ü—Ä–∏–±—ã–ª—å +1</button>
</div>
</div>

<!-- –ß–ê–¢–´ -->
<div class="card">
<h3>üí¨ –ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç</h3>
<div id="globalChat" style="height:120px;overflow:auto"></div>
<input id="globalInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
<button onclick="sendGlobal()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>

<div class="card">
<h3>üë• –ö–ª–∞–Ω–æ–≤—ã–π —á–∞—Ç</h3>
<div id="clanChat" style="height:120px;overflow:auto"></div>
<input id="clanInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∞–Ω—É">
<button onclick="sendClanMessageWithCommand()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>

<div class="card">
<h3>üü¢ –û–Ω–ª–∞–π–Ω –≤ –∫–ª–∞–Ω–µ</h3>
<div id="clanOnline"></div>
</div>

<!-- –†–ï–ô–¢–ò–ù–ì -->
<div class="card">
<h3>üèÜ –†–µ–π—Ç–∏–Ω–≥</h3>
<div id="rating"></div>
</div>

<button onclick="save()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// === CONFIG FIREBASE ===
const firebaseConfig = {
 apiKey: "–í–ê–®_API_KEY",
 authDomain: "PROJECT.firebaseapp.com",
 databaseURL: "https://PROJECT.firebaseio.com",
 projectId: "PROJECT"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// === –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
let user, clanId=null;
let data;
let contractTimer=null;
let lastMessageTime=0;

// –ë–∏–∑–Ω–µ—Å—ã
const businessesTemplate=[
 { name:"–ú–∞–≥–∞–∑–∏–Ω", level:1, speed:1, profit:1, active:false, progress:0 },
 { name:"–§–∞–±—Ä–∏–∫–∞", level:1, speed:1, profit:1, active:false, progress:0 },
 { name:"IT-–∫–æ–º–ø–∞–Ω–∏—è", level:1, speed:1, profit:1, active:false, progress:0 }
];

// === –î–ê–ù–ù–´–ï –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ ===
function defaultData(){return{
 money:0,
 stocks:0,
 stockPrice:100,
 season:1,
 seasonStart:Date.now(),
 businesses:JSON.parse(JSON.stringify(businessesTemplate)),
 contractEnd:0,
 loan:0,
 donations:{moneyBought:0, upgradesBought:{speed:0,profit:0}, lastPurchase:0}
};}

// === –í–•–û–î ===
function login(){
 user=document.getElementById("login").value.trim();
 if(!user) return alert("–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω");

 data=JSON.parse(localStorage.getItem("player_"+user))||defaultData();

 // –æ—Ñ–ª–∞–π–Ω –¥–æ—Ö–æ–¥
 const now=Date.now();
 const offlineIncome=Math.min(3600,(now-data.seasonStart)/1000)*calculateTotalIncome()/10;
 data.money+=Math.floor(offlineIncome);
 data.seasonStart=now;

 document.getElementById("playerName").innerText="üë§ "+user;
 updateSeason();
 render();
 show("game");

 setInterval(tick,1000);
 setInterval(stockMarket,5000);

 // –æ–Ω–ª–∞–π–Ω
 db.ref("users/"+user+"/online").set(true);
 db.ref("users/"+user+"/online").onDisconnect().set(false);
}

// === –ë–ò–ó–ù–ï–°–´ ===
function tick(){
 data.businesses.forEach(b=>{
   if(b.active){
     b.progress+=b.speed;
     if(b.progress>=10){
       b.progress=0;
       b.active=false;
       data.money+=b.profit*b.level;
     }
   }
 });
 render();
}

function startBusiness(i){data.businesses[i].active=true;}
function calculateTotalIncome(){return data.businesses.reduce((sum,b)=>sum+b.profit*b.level,0);}

// === –†–ï–ù–î–ï–† ===
function render(){
 document.getElementById("money").innerText=Math.floor(data.money);
 document.getElementById("stocks").innerText=data.stocks;
 document.getElementById("stockPrice").innerText=data.stockPrice;
 document.getElementById("season").innerText=data.season;

 let html="";
 data.businesses.forEach((b,i)=>{
   html+=`<div class="card"><b>${b.name}</b><br>–£—Ä–æ–≤–µ–Ω—å: ${b.level}, –°–∫–æ—Ä–æ—Å—Ç—å: ${b.speed}, –ü—Ä–∏–±—ã–ª—å: ${b.profit}<br>
   –°—Ç–∞—Ç—É—Å: ${b.active?"–†–∞–±–æ—Ç–∞–µ—Ç":"–û–∂–∏–¥–∞–µ—Ç"}<br>
   <button onclick="startBusiness(${i})">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button></div>`;
 });
 document.getElementById("businessList").innerHTML=html;

 updateRating();
}

// === –ê–ö–¶–ò–ò ===
function stockMarket(){
 const change=Math.floor(Math.random()*21-10);
 data.stockPrice=Math.max(10,data.stockPrice+change);
}
function buyStock(){if(data.money>=data.stockPrice){data.money-=data.stockPrice;data.stocks++;render();}}
function sellStock(){if(data.stocks>0){data.stocks--;data.money+=data.stockPrice;render();}}

// === –ö–û–ù–¢–†–ê–ö–¢–´ ===
function startContract(){
 if(data.contractEnd>Date.now()) return alert("–ö–æ–Ω—Ç—Ä–∞–∫—Ç –∞–∫—Ç–∏–≤–µ–Ω");
 data.contractEnd=Date.now()+20000;
 document.getElementById("contractStatus").innerText="–ö–æ–Ω—Ç—Ä–∞–∫—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...";
 contractTimer=setTimeout(()=>{
   data.money+=800;
   data.contractEnd=0;
   render();
   alert("–ö–æ–Ω—Ç—Ä–∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω! +800‚ÇΩ");
 },20000);
}

// === –ö–†–ï–î–ò–¢–´ ===
function takeLoan(){if(data.loan>0)return alert("–£–∂–µ –µ—Å—Ç—å –∫—Ä–µ–¥–∏—Ç");data.loan=1200;data.money+=1000;render();}
function repayLoan(){if(data.loan===0)return; if(data.money>=data.loan){data.money-=data.loan;data.loan=0;render();}else alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥");}

// === –°–ï–ó–û–ù–´ ===
function updateSeason(){if(Date.now()-data.seasonStart>=86400000){data.season++;data.seasonStart=Date.now();data.money+=1000;}}

// === –†–ï–ô–¢–ò–ù–ì ===
function updateRating(){
 let rating=JSON.parse(localStorage.getItem("rating")||"{}");
 rating[user]=data.money;
 localStorage.setItem("rating",JSON.stringify(rating));
 let html="";
 Object.entries(rating).sort((a,b)=>b[1]-a[1]).forEach(r=>html+=`${r[0]} ‚Äî ${r[1]}‚ÇΩ<br>`);
 document.getElementById("rating").innerHTML=html;
}

// === –ß–ê–¢ –ì–õ–û–ë–ê–õ–¨–ù–´–ô ===
const globalChatRef=db.ref("chat/global").limitToLast(50);
globalChatRef.on("child_added",snap=>{const m=snap.val();globalChat.innerHTML+=`<div><b>${m.user}:</b> ${m.text}</div>`;globalChat.scrollTop=9999;});
function canChat(cb){db.ref("users/"+user+"/muted").once("value",s=>{if(s.val())return alert("üö´ –í–∞–º –∑–∞–ø—Ä–µ—â—ë–Ω —á–∞—Ç"); const now=Date.now(); if(now-lastMessageTime<3000)return alert("‚è± –ü–æ–¥–æ–∂–¥–∏—Ç–µ 3 —Å–µ–∫"); lastMessageTime=now; cb();});}
function sendGlobal(){canChat(()=>{const text=document.getElementById("globalInput").value.trim();if(!text)return; db.ref("chat/global").push({user,text,time:Date.now()});document.getElementById("globalInput").value="";});}

// === –ö–õ–ê–ù–û–í–´–ô –ß–ê–¢ ===
function sendClanMessage(){if(!clanId)return alert("–í—ã –Ω–µ –≤ –∫–ª–∞–Ω–µ"); const text=document.getElementById("clanInput").value.trim();if(!text)return; canChat(()=>{db.ref(`clans/${clanId}/chat`).push({user,text,time:Date.now()});document.getElementById("clanInput").value="";});}
function sendClanMessageWithCommand(){const text=document.getElementById("clanInput").value.trim();if(!text)return; if(processCommand(text)){document.getElementById("clanInput").value="";return;} sendClanMessage();}

// === –ß–ê–¢-–ö–û–ú–ê–ù–î–´ (/mute / /ban) ===
function isAdmin(userId,callback){db.ref(`clans/${clanId}/members/${userId}/role`).once("value",snap=>callback(snap.val()==="admin"));}
function processCommand(text){
 if(!text.startsWith("/"))return false;
 const args=text.split(" ");const cmd=args[0].toLowerCase();
 if(cmd==="/mute"){const target=args[1];isAdmin(user,ok=>{if(ok)db.ref(`users/${target}/muted`).set(true);});}
 if(cmd==="/ban"){const target=args[1];isAdmin(user,ok=>{if(ok)db.ref(`clans/${clanId}/members/${target}`).remove();});}
 return true;
}

// === –û–ù–õ–ê–ô–ù-–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò –í –ö–õ–ê–ù–ï ===
db.ref(`clans/${clanId}/members`).on("value",snap=>{let html=""; snap.forEach(u=>{const status=u.val().online?"üü¢":"üî¥"; html+=`${status} ${u.key} (${u.val().role})<br>`}); document.getElementById("clanOnline").innerHTML=html;});

// === –î–û–ù–ê–¢ ===
function buyMoney(){if(!confirm("–ö—É–ø–∏—Ç—å 1000‚ÇΩ –∑–∞ —Ä–µ–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂?"))return; data.money+=1000; data.donations.moneyBought+=1000; render(); saveOnline(); alert("–í—ã –∫—É–ø–∏–ª–∏ 1000‚ÇΩ");}
function buySpeed(){if(!confirm("–ö—É–ø–∏—Ç—å +1 –∫ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤—Å–µ—Ö –±–∏–∑–Ω–µ—Å–æ–≤?"))return; data.businesses.forEach(b=>b.speed+=1); data.donations.upgradesBought.speed+=1; render(); saveOnline(); alert("–°–∫–æ—Ä–æ—Å—Ç—å –±–∏–∑–Ω–µ—Å–∞ —É–≤–µ–ª–∏—á–µ–Ω–∞!");}
function buyProfit(){if(!confirm("–ö—É–ø–∏—Ç—å +1 –∫ –ø—Ä–∏–±—ã–ª–∏ –≤—Å–µ—Ö –±–∏–∑–Ω–µ—Å–æ–≤?"))return; data.businesses.forEach(b=>b.profit+=1); data.donations.upgradesBought.profit+=1; render(); saveOnline(); alert("–ü—Ä–∏–±—ã–ª—å –±–∏–∑–Ω–µ—Å–∞ —É–≤–µ–ª–∏—á–µ–Ω–∞!");}

// === –°–ï–ì–ú–ï–ù–¢ –£–¢–ò–õ–ò–¢–´ ===
function save(){localStorage.setItem("player_"+user,JSON.stringify(data));alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");}
function show(id){document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));document.getElementById(id).classList.add("active");}
function saveOnline(){db.ref("users/"+user).set(data);}
</script>
</body>
</html>
